<!DOCTYPE html>
<!--
  2026 Crypto Voter Map â€” Stand With Crypto x Bitcoin Magazine

  Embed this map on your site:
  <iframe src="https://your-domain.com/index.html" width="100%" height="840" frameborder="0" allow="geolocation"></iframe>
-->
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>2026 Crypto Voter Map Â· Stand With Crypto</title>

  <!-- CDN dependencies (no build step required) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3/dist/topojson-client.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui'] },
        },
      },
    };
  </script>

  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body, #root { height: 100%; }
    body { background: #0D0D1A; color: #fff; font-family: 'Inter', ui-sans-serif, system-ui; }

    .swc-scroll::-webkit-scrollbar { width: 4px; }
    .swc-scroll::-webkit-scrollbar-track { background: #1A1730; }
    .swc-scroll::-webkit-scrollbar-thumb { background: #2D2A4A; border-radius: 2px; }
    .swc-scroll::-webkit-scrollbar-thumb:hover { background: #F7931A; }

    .state-path { cursor: pointer; transition: opacity 0.12s ease, stroke-width 0.12s ease; }
    .state-path:hover { opacity: 0.72; }
    .state-path:focus { outline: none; stroke: #FFAD4D !important; stroke-width: 2.5px !important; }

    @keyframes slideInRight { from { opacity: 0; transform: translateX(24px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes slideInUp { from { opacity: 0; transform: translateY(32px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .anim-slide-right { animation: slideInRight 0.22s ease; }
    .anim-slide-up    { animation: slideInUp 0.25s ease; }
    .anim-fade        { animation: fadeIn 0.18s ease; }
    .anim-pulse       { animation: pulse 1.5s ease infinite; }

    /* Address autocomplete dropdown styling */
    .ac-dropdown { position: absolute; left: 0; right: 0; top: 100%; z-index: 100; background: #1A1730; border: 1px solid #2D2A4A; border-radius: 8px; margin-top: 4px; font-family: 'Inter', sans-serif; overflow: hidden; max-height: 240px; overflow-y: auto; }
    .ac-item { padding: 8px 12px; color: #fff; border-top: 1px solid #2D2A4A; cursor: pointer; font-size: 13px; }
    .ac-item:first-child { border-top: none; }
    .ac-item:hover, .ac-item.selected { background: #2D2A4A; }
    .ac-item .ac-main { color: #F7931A; font-size: 14px; }
    .ac-item .ac-sub  { color: #9ca3af; font-size: 12px; margin-top: 1px; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel" data-presets="react">
    const { useState, useEffect, useRef, useCallback, useMemo } = React;

    /* ================================================================
       CONFIG â€” swap API keys here for deployment
       ================================================================ */
    const CONFIG = {
      SWC_API_URL:  "https://www.standwithcrypto.org/api/public/dtsi/all-people/us",
      TOPO_URL:     "https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json",
      SWC_JOIN_URL: "https://www.standwithcrypto.org?utm_source=bitcoinmagazine&utm_medium=verified-partner&utm_content=map",
      SWC_PROFILE:  "https://www.standwithcrypto.org/politicians",
    };

    /* ================================================================
       FIPS â†” State mappings
       ================================================================ */
    const STATES = {
      "01":{name:"Alabama",abbr:"AL"},"02":{name:"Alaska",abbr:"AK"},
      "04":{name:"Arizona",abbr:"AZ"},"05":{name:"Arkansas",abbr:"AR"},
      "06":{name:"California",abbr:"CA"},"08":{name:"Colorado",abbr:"CO"},
      "09":{name:"Connecticut",abbr:"CT"},"10":{name:"Delaware",abbr:"DE"},
      "11":{name:"Dist. of Columbia",abbr:"DC"},"12":{name:"Florida",abbr:"FL"},
      "13":{name:"Georgia",abbr:"GA"},"15":{name:"Hawaii",abbr:"HI"},
      "16":{name:"Idaho",abbr:"ID"},"17":{name:"Illinois",abbr:"IL"},
      "18":{name:"Indiana",abbr:"IN"},"19":{name:"Iowa",abbr:"IA"},
      "20":{name:"Kansas",abbr:"KS"},"21":{name:"Kentucky",abbr:"KY"},
      "22":{name:"Louisiana",abbr:"LA"},"23":{name:"Maine",abbr:"ME"},
      "24":{name:"Maryland",abbr:"MD"},"25":{name:"Massachusetts",abbr:"MA"},
      "26":{name:"Michigan",abbr:"MI"},"27":{name:"Minnesota",abbr:"MN"},
      "28":{name:"Mississippi",abbr:"MS"},"29":{name:"Missouri",abbr:"MO"},
      "30":{name:"Montana",abbr:"MT"},"31":{name:"Nebraska",abbr:"NE"},
      "32":{name:"Nevada",abbr:"NV"},"33":{name:"New Hampshire",abbr:"NH"},
      "34":{name:"New Jersey",abbr:"NJ"},"35":{name:"New Mexico",abbr:"NM"},
      "36":{name:"New York",abbr:"NY"},"37":{name:"North Carolina",abbr:"NC"},
      "38":{name:"North Dakota",abbr:"ND"},"39":{name:"Ohio",abbr:"OH"},
      "40":{name:"Oklahoma",abbr:"OK"},"41":{name:"Oregon",abbr:"OR"},
      "42":{name:"Pennsylvania",abbr:"PA"},"44":{name:"Rhode Island",abbr:"RI"},
      "45":{name:"South Carolina",abbr:"SC"},"46":{name:"South Dakota",abbr:"SD"},
      "47":{name:"Tennessee",abbr:"TN"},"48":{name:"Texas",abbr:"TX"},
      "49":{name:"Utah",abbr:"UT"},"50":{name:"Vermont",abbr:"VT"},
      "51":{name:"Virginia",abbr:"VA"},"53":{name:"Washington",abbr:"WA"},
      "54":{name:"West Virginia",abbr:"WV"},"55":{name:"Wisconsin",abbr:"WI"},
      "56":{name:"Wyoming",abbr:"WY"},
    };
    const ABBR_TO_FIPS = Object.fromEntries(
      Object.entries(STATES).map(([fips, { abbr }]) => [abbr, fips])
    );

    /* ================================================================
       Rating display logic (letter grades)
       Score 90â€“100  A  Strongly Pro-Crypto  #22C55E
       Score 70â€“89   B  Pro-Crypto           #84CC16
       Score 40â€“69   C  Neutral              #F97316
       Score 0â€“39    F  Anti-Crypto          #EF4444
       null          â€”  Not Yet Rated        #9CA3AF
       ================================================================ */
    function getRating(score) {
      if (score == null) return { label: 'Not Yet Rated', grade: 'â€”', color: '#9CA3AF', badge: 'â€”' };
      if (score >= 90)   return { label: 'Strongly Pro-Crypto', grade: 'A',  color: '#22C55E', badge: 'ğŸ…°ï¸' };
      if (score >= 70)   return { label: 'Pro-Crypto',          grade: 'B',  color: '#84CC16', badge: 'ğŸ…±ï¸' };
      if (score >= 40)   return { label: 'Neutral',             grade: 'C',  color: '#F97316', badge: 'Â©ï¸' };
      return                     { label: 'Anti-Crypto',        grade: 'F',  color: '#EF4444', badge: 'ğŸ…µ' };
    }

    const PARTY_STYLE = {
      US_REPUBLICAN:  { abbr: 'R', label: 'Republican',  color: '#F87171' },
      US_DEMOCRAT:    { abbr: 'D', label: 'Democrat',    color: '#60A5FA' },
      US_INDEPENDENT: { abbr: 'I', label: 'Independent', color: '#A3A3A3' },
    };
    function getParty(v) { return PARTY_STYLE[v] ?? { abbr: '?', label: 'Unknown', color: '#9CA3AF' }; }

    /* ================================================================
       RACE DERIVATION LOGIC

       The SWC API sets dateEnd to 2027-01-03 for ALL senators (end of
       119th Congress), so we cannot use it to distinguish Senate classes.
       Instead we hardcode the 33 Class 2 seats (up Nov 2026) plus 2
       special elections (FL, OH) using the incumbent's last name.

       HOUSE â€” All 435 seats are contested every two years.

       We ignore roleCategory "PRESIDENT", "GOVERNOR", "ATTORNEY_GENERAL".
       ================================================================ */

    // Class 2 senators up for election in 2026 (source: senate.gov)
    // Key = state abbreviation, Value = incumbent last name for matching
    // Senators NOT seeking re-election â†’ label as "Open Seat" / "Retiring"
    const RETIRING_SENATORS = new Set([
      'Shaheen',     // NH â€” retiring
      'Smith',       // MN â€” not seeking re-election
      'Peters',      // MI â€” not running
      'Durbin',      // IL â€” not running
      'McConnell',   // KY â€” not running
      'Tuberville',  // AL â€” running for governor
      'Ernst',       // IA â€” not seeking third term
      'Merkley',     // OR â€” running for governor
    ]);

    const SENATE_2026 = {
      AL: 'Tuberville', AK: 'Sullivan', AR: 'Cotton', CO: 'Hickenlooper',
      DE: 'Coons', GA: 'Ossoff', ID: 'Risch', IL: 'Durbin',
      IA: 'Ernst', KS: 'Marshall', KY: 'McConnell', LA: 'Cassidy',
      ME: 'Collins', MA: 'Markey', MI: 'Peters', MN: 'Smith',
      MS: 'Hyde-Smith', MT: 'Daines', NE: 'Ricketts', NH: 'Shaheen',
      NJ: 'Booker', NM: 'LujÃ¡n', NC: 'Tillis', OK: 'Mullin',
      OR: 'Merkley', RI: 'Reed', SC: 'Graham', SD: 'Rounds',
      TN: 'Hagerty', TX: 'Cornyn', VA: 'Warner', WV: 'Capito', WY: 'Lummis',
      // 2026 Special elections (Class 3 vacancies)
      FL: 'Moody', OH: 'Husted',
    };

    function isClass2Senator(person) {
      const abbr = person.primaryRole?.primaryState;
      if (!abbr || !SENATE_2026[abbr]) return false;
      const lastName = person.lastName || '';
      // Check if this person's term has expired (i.e., they're no longer the current holder)
      const termExpired = person.primaryRole?.dateEnd && new Date(person.primaryRole.dateEnd) < new Date();
      // Match incumbents by last name, or include challengers (status !== HELD or expired term)
      if (person.primaryRole?.status !== 'HELD' || termExpired) return true; // challenger for this seat
      return lastName === SENATE_2026[abbr] || lastName.includes(SENATE_2026[abbr]);
    }

    function buildRaces(people) {
      const byState = {};                       // { fips: { senate, house: { [dist]: race } } }

      people.forEach(p => {
        const role = p.primaryRole;
        if (!role) return;
        const cat = role.roleCategory;
        if (cat !== 'SENATE' && cat !== 'CONGRESS') return;

        const abbr = role.primaryState;
        if (!abbr) return;
        const fips = ABBR_TO_FIPS[abbr];
        if (!fips) return;

        if (!byState[fips]) byState[fips] = { senate: null, house: {} };

        const score = p.manuallyOverriddenStanceScore ?? p.computedStanceScore;
        const lastName = p.lastName || '';
        // Check if term has expired â€” API sometimes keeps status=HELD even after dateEnd passes
        const termExpired = role.dateEnd && new Date(role.dateEnd) < new Date();
        const isIncumbent = role.status === 'HELD' && !termExpired;
        const isRetiring = isIncumbent && RETIRING_SENATORS.has(lastName);
        const candidate = {
          id: p.id,
          slug: p.slug,
          name: `${p.firstNickname || p.firstName} ${lastName}${p.nameSuffix ? ' ' + p.nameSuffix : ''}`,
          party: p.politicalAffiliationCategoryV2,
          score,
          photo: p.profilePictureUrl,
          donationUrl: p.donationUrl,
          officialUrl: p.officialUrl,
          isIncumbent,
          isRetiring,
          isPriority: p.promotedPositioning != null && p.promotedPositioning <= 10,
        };

        if (cat === 'SENATE') {
          // Only include Class 2 seats + 2026 special elections
          if (SENATE_2026[abbr] && isClass2Senator(p)) {
            if (!byState[fips].senate) byState[fips].senate = { candidates: [], isPriority: false };
            byState[fips].senate.candidates.push(candidate);
            if (candidate.isPriority) byState[fips].senate.isPriority = true;
          }
        } else {
          // HOUSE â€” every seat is up in 2026
          const dist = role.primaryDistrict || 'AL';
          if (!byState[fips].house[dist]) byState[fips].house[dist] = { candidates: [], isPriority: false };
          byState[fips].house[dist].candidates.push(candidate);
          if (candidate.isPriority) byState[fips].house[dist].isPriority = true;
        }
      });

      // Sort candidates within each race: incumbents first, then by score desc
      Object.values(byState).forEach(s => {
        const sortFn = (a, b) => (b.isIncumbent - a.isIncumbent) || ((b.score ?? -1) - (a.score ?? -1));
        if (s.senate) s.senate.candidates.sort(sortFn);
        Object.values(s.house).forEach(r => r.candidates.sort(sortFn));
      });

      return byState;
    }

    /* State map colour based on candidate crypto stance */
    function getStateColor(raceData) {
      if (!raceData) return '#1E1B2E';
      const hasHouse = Object.keys(raceData.house).length > 0;
      if (!raceData.senate && !hasHouse) return '#1E1B2E';
      // Senate race â†’ muted warm orange; House only â†’ muted purple
      if (raceData.senate) return '#F7931A';
      return '#7B3FE4';
    }

    /* ================================================================
       Census Geocoder â€” resolve address â†’ congressional district
       ================================================================ */
    async function censusLookup(address) {
      // Use our Vercel serverless proxy to avoid CORS issues with Census API
      const proxyUrl = '/api/geocode?address=' + encodeURIComponent(address);
      // Fall back to direct Census API for local development
      const directUrl = 'https://geocoding.geo.census.gov/geocoder/geographies/onelineaddress'
        + `?address=${encodeURIComponent(address)}`
        + '&benchmark=Public_AR_Current&vintage=Current_Current&format=json';

      try {
        const r = await fetch(proxyUrl);
        const d = await r.json();
        if (d.state) return d;
        return null;
      } catch {
        // Proxy unavailable (local dev) â€” try direct Census API
        const r = await fetch(directUrl);
        const d = await r.json();
        const m = d?.result?.addressMatches?.[0];
        if (!m) return null;
        const stateAbbr = m.addressComponents?.state;
        const geos = m.geographies || {};
        const cdKey = Object.keys(geos).find(k => k.toLowerCase().includes('congressional'));
        const cd = cdKey ? geos[cdKey]?.[0] : null;
        const dist = cd?.BASENAME ?? cd?.CD ?? null;
        return { state: stateAbbr, district: dist ? String(parseInt(dist)) : null, formatted: m.matchedAddress };
      }
    }

    /*
     * Decode compact fallback data format back to API-like objects.
     * Compact: [name, party, score, state, role, distOrUp, incumbent, priority, slug, photo]
     */
    function decodeCompactData(arr) {
      const PARTY_MAP = { R: 'US_REPUBLICAN', D: 'US_DEMOCRAT', I: 'US_INDEPENDENT' };
      return arr.map(r => ({
        id: r[8] || Math.random().toString(36).slice(2),
        slug: r[8],
        firstName: r[0].split(' ')[0],
        lastName: r[0].split(' ').slice(1).join(' '),
        politicalAffiliationCategoryV2: PARTY_MAP[r[1]] || null,
        computedStanceScore: r[2] === -1 ? null : r[2],
        manuallyOverriddenStanceScore: null,
        profilePictureUrl: r[9] || null,
        promotedPositioning: r[7] === 1 ? 1 : null,
        donationUrl: null,
        officialUrl: null,
        primaryRole: {
          roleCategory: r[4] === 'S' ? 'SENATE' : 'CONGRESS',
          primaryState: r[3],
          primaryDistrict: r[4] === 'H' ? (r[5] || '') : '',
          status: r[6] === 1 ? 'HELD' : 'RUNNING_FOR',
          dateEnd: (r[4] === 'S' && r[5] === 1) ? '2027-01-03T00:00:00.000Z' : '',
        },
      }));
    }

    /* Nominatim (OpenStreetMap) address autocomplete â€” free, no API key needed */
    let _nominatimTimer = null;
    function nominatimAutocomplete(query) {
      return new Promise((resolve) => {
        clearTimeout(_nominatimTimer);
        if (!query || query.length < 3) { resolve([]); return; }
        _nominatimTimer = setTimeout(async () => {
          try {
            const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&countrycodes=us&format=json&addressdetails=1&limit=5`;
            const r = await fetch(url, { headers: { 'Accept': 'application/json' } });
            const data = await r.json();
            resolve(data.map(d => ({
              display: d.display_name,
              main: d.address?.road ? `${d.address.house_number || ''} ${d.address.road}`.trim() : d.display_name.split(',')[0],
              sub: d.display_name.split(',').slice(1, 4).join(',').trim(),
              state: d.address?.['ISO3166-2-lvl4']?.replace('US-', '') || d.address?.state || '',
              full: d.display_name,
            })));
          } catch { resolve([]); }
        }, 300); // debounce 300ms to respect Nominatim rate limits
      });
    }

    /* ================================================================
       COMPONENTS
       ================================================================ */

    function ShieldIcon({ size = 24 }) {
      const id = 'swc-s-' + size;
      return (
        <svg width={size} height={size * (32/33)} viewBox="0 0 33 32" fill="none" aria-hidden="true">
          <path d="M24.29 0H16.21V32l3.46-1.18C26.83 28.38 31.84 21.89 32.37 14.34V0h-8.08z" fill={`url(#${id}a)`}/>
          <path d="M8.12 0H.04v14.34c.54 7.55 5.54 14.04 12.7 16.48L16.21 32V0H8.12z" fill={`url(#${id}b)`}/>
          <defs>
            <linearGradient id={`${id}a`} x1="24.29" y1="0" x2="24.29" y2="32" gradientUnits="userSpaceOnUse">
              <stop stopColor="#E2D0FF"/><stop offset="1" stopColor="#6100FF"/>
            </linearGradient>
            <linearGradient id={`${id}b`} x1="8.12" y1="0" x2="8.12" y2="32" gradientUnits="userSpaceOnUse">
              <stop stopColor="#6C11FF"/><stop offset="1" stopColor="#E2D0FF"/>
            </linearGradient>
          </defs>
        </svg>
      );
    }

    function SWCFullLogo({ height = 28 }) {
      const w = height * (91/32);
      return (
        <svg width={w} height={height} viewBox="0 0 91 32" fill="none" aria-hidden="true">
          <path d="M8.12 0.02H.04v14.34c.54 7.55 5.54 14.04 12.7 16.48L16.21 32V.02H8.12z" fill="url(#swcfl-a)"/>
          <path d="M24.29.02H16.21V32l3.46-1.18c7.16-2.44 12.17-8.93 12.7-16.48V.02h-8.08z" fill="url(#swcfl-b)"/>
          <path d="M41.97 9.82c-2.4 0-4-.76-4-2.6h2.19c0 .92.69 1.37 1.84 1.37s1.72-.49 1.72-1.13c0-.71-.47-.85-1.44-1l-1.17-.17c-1.72-.25-2.93-1.05-2.93-2.85 0-1.63 1.4-2.93 3.79-2.93s3.83 1.32 3.85 2.89h-2.19c0-.69-.48-1.19-1.65-1.19s-1.59.51-1.59 1.04c0 .71.49.91 1.4 1.04l1.13.16c1.67.24 3.03.92 3.03 2.83 0 1.9-1.6 3.02-3.95 3.02z" fill="#fff"/>
          <path d="M49.27 2.1h-2.9V.23h7.95V2.1h-2.89v7.52h-2.16V2.1z" fill="#fff"/>
          <path d="M60.08 9.62l-.59-1.7h-3.77l-.57 1.7h-2.23l3.48-9.39h2.51l3.48 9.39h-2.31zm-2.51-7.12L56.36 6.06h2.48l-1.24-3.56z" fill="#fff"/>
          <path d="M63.13 9.62V.23h2.47l3.76 6.12h.01V.23h2.05v9.39h-2.32l-3.87-6.41h-.01v6.41h-2.09z" fill="#fff"/>
          <path d="M76.63.23c2.88 0 4.55 2.07 4.55 4.69 0 2.63-1.65 4.69-4.55 4.69h-3.76V.23h3.76zm0 1.87h-1.6v5.65h1.6c1.28 0 2.33-.88 2.33-2.45v-.76c0-1.56-1.05-2.44-2.33-2.44z" fill="#fff"/>
          <path d="M37.75 11.23h2.28l1.63 6.03h.03l1.71-6.05h1.96l1.73 6.08h.03l1.61-6.08h2.09l-2.68 9.4h-2.04l-1.81-6.13h-.03l-1.8 6.13h-1.93l-2.77-9.4z" fill="#fff"/>
          <path d="M51.58 11.23h2.16v9.39h-2.16v-9.39z" fill="#fff"/>
          <path d="M57.58 13.1h-2.89v-1.87h7.95v1.87h-2.89v7.52h-2.16V13.1z" fill="#fff"/>
          <path d="M63.6 11.23h2.16v3.65h3.92v-3.65h2.16v9.39h-2.16v-3.87h-3.92v3.87H63.6v-9.39z" fill="#fff"/>
          <path d="M42.51 29.92c1.2 0 1.75-.68 1.87-1.4h2.25c-.32 1.97-1.85 3.28-4.04 3.28-2.95 0-4.52-2.12-4.52-4.88s1.59-4.89 4.52-4.89c2.17 0 3.72 1.33 4.01 3.16h-2.28c-.15-.75-.75-1.28-1.81-1.28-1.23 0-2.23.95-2.23 2.65v.71c0 1.71 1 2.65 2.23 2.65z" fill="#fff"/>
          <path d="M47.62 31.62V22.23h4.44c2.21 0 3.39 1.29 3.39 2.99 0 1.59-1 2.69-2.88 2.83l3.56 3.57h-2.99l-3.36-3.49v3.49h-2.16zm5.64-6.29v-.13c0-.76-.45-1.15-1.27-1.15h-2.21v2.41h2.21c.81 0 1.27-.4 1.27-1.13z" fill="#fff"/>
          <path d="M58.75 31.62v-3.49l-3.29-5.89h2.33l2.05 3.8h.03l2.05-3.8h2.31l-3.32 5.89v3.49h-2.16z" fill="#fff"/>
          <path d="M64.95 31.62V22.23h4.43c2.21 0 3.39 1.31 3.39 3.01 0 1.71-1.17 3.01-3.39 3.01h-2.27v3.36h-2.16zm5.63-6.31v-.13c0-.73-.45-1.11-1.27-1.11h-2.2v2.35h2.2c.81 0 1.27-.39 1.27-1.11z" fill="#fff"/>
          <path d="M76.11 24.1h-2.89v-1.87h7.95v1.87h-2.89v7.52h-2.16V24.1z" fill="#fff"/>
          <path d="M85.97 31.8c-2.89 0-4.55-2.13-4.55-4.88s1.67-4.89 4.55-4.89c2.88 0 4.55 2.16 4.55 4.89s-1.65 4.88-4.55 4.88zm0-1.88c1.28 0 2.33-.95 2.33-2.65v-.71c0-1.71-1.05-2.65-2.33-2.65s-2.33.95-2.33 2.65v.71c0 1.71 1.05 2.65 2.33 2.65z" fill="#fff"/>
          <defs>
            <linearGradient id="swcfl-a" x1="8.12" y1=".02" x2="8.12" y2="32" gradientUnits="userSpaceOnUse">
              <stop stopColor="#6C11FF"/><stop offset="1" stopColor="#E2D0FF"/>
            </linearGradient>
            <linearGradient id="swcfl-b" x1="24.29" y1=".02" x2="24.29" y2="32" gradientUnits="userSpaceOnUse">
              <stop stopColor="#E2D0FF"/><stop offset="1" stopColor="#6100FF"/>
            </linearGradient>
          </defs>
        </svg>
      );
    }

    function CTAButton({ size = 'md', className = '', block = false }) {
      const pad = { sm: 'px-3 py-1.5 text-xs', md: 'px-4 py-2 text-sm', lg: 'px-5 py-3 text-base' }[size];
      return (
        <a
          href={CONFIG.SWC_JOIN_URL}
          target="_blank"
          rel="noopener noreferrer"
          className={`
            inline-flex items-center justify-center gap-2 font-bold rounded-xl
            bg-[#F7931A] hover:bg-[#FFAD4D] active:bg-[#E8850F]
            text-white transition-colors duration-150 select-none
            ${pad} ${block ? 'w-full' : ''} ${className}
          `}
        >
          <ShieldIcon size={size === 'lg' ? 22 : size === 'md' ? 18 : 15} />
          Join Stand With Crypto
        </a>
      );
    }

    function CloseBtn({ onClick }) {
      return (
        <button onClick={onClick} className="ml-2 p-1.5 rounded-lg text-[#9CA3AF] hover:text-white hover:bg-[#2D2A4A] transition-colors flex-shrink-0" aria-label="Close panel">
          <svg width="14" height="14" viewBox="0 0 14 14" fill="none"><path d="M1 1l12 12M13 1L1 13" stroke="currentColor" strokeWidth="2" strokeLinecap="round" /></svg>
        </button>
      );
    }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function Header({ totalPoliticians }) {
      return (
        <header className="flex items-center justify-between px-4 py-3 border-b border-[#2D2A4A] bg-[#0D0D1A] z-20 flex-shrink-0">
          <div className="flex items-center gap-3">
            <SWCFullLogo height={26} />
            <div className="w-px h-6 bg-[#2D2A4A] hidden sm:block" />
            <div>
              <h1 className="text-white font-bold text-sm sm:text-base leading-tight">2026 Midterm Map</h1>
              <p className="text-[#6B7280] text-[10px] hidden sm:block">Track every Senate & House race</p>
            </div>
          </div>
          <div className="flex items-center gap-3">
            {totalPoliticians > 0 && (
              <span className="text-[#6B7280] text-xs hidden md:block">
                <span className="text-[#F7931A] font-semibold">{totalPoliticians}</span> politicians tracked
              </span>
            )}
            <CTAButton size="sm" className="hidden sm:inline-flex" />
          </div>
        </header>
      );
    }

    /* â”€â”€ Candidate Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function CandidateCard({ c }) {
      const rating = getRating(c.score);
      const party  = getParty(c.party);
      const profileUrl = c.slug ? `${CONFIG.SWC_PROFILE}/${c.slug}` : null;

      return (
        <div className="flex gap-3 py-3 border-b border-[#2D2A4A] last:border-0">
          {/* Photo */}
          {c.photo ? (
            <img src={c.photo} alt="" className="w-11 h-11 rounded-full object-cover flex-shrink-0 border-2" style={{ borderColor: rating.color }} onError={e => { e.target.style.display = 'none'; }} />
          ) : (
            <div className="w-11 h-11 rounded-full bg-[#2D2A4A] flex items-center justify-center flex-shrink-0 text-base font-bold text-[#6B7280]">{c.name.charAt(0)}</div>
          )}
          <div className="flex-1 min-w-0">
            <div className="flex items-center gap-1.5 flex-wrap">
              <span className="text-white text-sm font-semibold truncate">{c.name}</span>
              <span className="text-[11px] px-1.5 py-0.5 rounded font-semibold" style={{ backgroundColor: party.color + '22', color: party.color }}>({party.abbr})</span>
            </div>
            <div className="flex items-center gap-2 mt-0.5 flex-wrap">
              <span className="text-[#6B7280] text-xs">{c.isRetiring ? 'Retiring Â· Not Running' : c.isIncumbent ? 'Incumbent' : 'Challenger'}</span>
              {c.isRetiring && <span className="text-[11px] px-1.5 py-0.5 rounded bg-amber-500/20 text-amber-400 font-medium">Open Seat</span>}
              {c.isPriority && <span className="text-[11px] px-1.5 py-0.5 rounded bg-yellow-500/20 text-yellow-400 font-medium">â­ Priority Race</span>}
            </div>
            <div className="mt-1">
              <span className="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-xs font-medium" style={{ backgroundColor: rating.color + '22', color: rating.color }}>
                <span className="font-bold text-sm">{rating.grade}</span> {rating.label}
              </span>
            </div>
            <div className="flex items-center gap-3 mt-1.5">
              {profileUrl && <a href={profileUrl} target="_blank" rel="noopener noreferrer" className="text-[11px] text-[#9B6FF4] hover:text-[#7B3FE4] transition-colors">View on SWC â†—</a>}
              {c.donationUrl && <a href={c.donationUrl} target="_blank" rel="noopener noreferrer" className="text-[11px] text-[#9B6FF4] hover:text-[#7B3FE4] transition-colors">Donate â†—</a>}
            </div>
          </div>
        </div>
      );
    }

    /* â”€â”€ Race Section â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function RaceSection({ title, race }) {
      const has = race?.candidates?.length > 0;
      const isOpen = race?.candidates?.some(c => c.isRetiring);
      return (
        <div className="mb-4">
          <div className="flex items-center gap-2 mb-1">
            <div className="text-[#6B7280] text-[11px] uppercase tracking-widest font-semibold">{title}</div>
            {isOpen && <span className="text-[11px] px-1.5 py-0.5 rounded bg-amber-500/20 text-amber-400 font-medium">Open Seat</span>}
            {race?.isPriority && <span className="text-[11px] px-1.5 py-0.5 rounded bg-yellow-500/20 text-yellow-400 font-medium">â­ Priority</span>}
          </div>
          <div className="border-t border-[#2D2A4A] mb-1" />
          {has ? (
            <>
              {race.candidates.map(c => <CandidateCard key={c.id} c={c} />)}
              {race.candidates.length === 1 && <p className="text-[#6B7280] text-xs italic mt-1">Challenger ratings coming soon.</p>}
            </>
          ) : (
            <p className="text-[#6B7280] text-xs italic py-2">No candidates rated yet for this race.</p>
          )}
        </div>
      );
    }

    /* â”€â”€ State Detail Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function StatePanel({ fips, races, onClose }) {
      const state = STATES[fips];
      const scrollRef = useRef(null);
      if (!state) return null;
      const data = races[fips];
      const houseKeys = data ? Object.keys(data.house).sort((a, b) => a === 'AL' ? -1 : b === 'AL' ? 1 : parseInt(a) - parseInt(b)) : [];

      // Reset scroll when state changes
      useEffect(() => { scrollRef.current?.scrollTo(0, 0); }, [fips]);

      return (
        <div className="anim-slide-right flex flex-col h-full overflow-hidden">
          <div className="flex items-start justify-between p-4 border-b border-[#2D2A4A] flex-shrink-0">
            <div>
              <h2 className="text-white font-bold text-lg">{state.name} â€” 2026 Races</h2>
            </div>
            <CloseBtn onClick={onClose} />
          </div>

          <div ref={scrollRef} className="flex-1 overflow-y-auto swc-scroll px-4 py-3">
            {!data ? (
              <div className="text-center py-10">
                <p className="text-[#9CA3AF] text-sm mb-4">No rated candidates yet for {state.name}. Sign up at Stand With Crypto to stay informed.</p>
                <CTAButton size="sm" />
              </div>
            ) : (
              <>
                {/* Senate section */}
                {data.senate ? (
                  <RaceSection title={`U.S. Senate â€” ${state.name}`} race={data.senate} />
                ) : (
                  <div className="mb-4">
                    <div className="text-[#6B7280] text-[11px] uppercase tracking-widest font-semibold mb-1">U.S. Senate</div>
                    <div className="border-t border-[#2D2A4A] mb-1" />
                    <p className="text-[#6B7280] text-xs italic py-2">This state's Senate seat is not up for election in 2026.</p>
                  </div>
                )}

                {/* House sections â€” one per district */}
                {houseKeys.length > 0 ? houseKeys.map(dist => (
                  <RaceSection key={dist} title={`U.S. House â€” ${state.abbr}-${dist === 'AL' ? 'At Large' : dist}`} race={data.house[dist]} />
                )) : (
                  <div className="mb-4">
                    <div className="text-[#6B7280] text-[11px] uppercase tracking-widest font-semibold mb-1">U.S. House</div>
                    <div className="border-t border-[#2D2A4A] mb-1" />
                    <p className="text-[#6B7280] text-xs italic py-2">No rated House candidates for {state.name} yet.</p>
                  </div>
                )}
              </>
            )}
          </div>

          <div className="p-4 border-t border-[#2D2A4A] flex-shrink-0">
            <CTAButton size="lg" block />
          </div>
        </div>
      );
    }

    /* â”€â”€ My Races Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function MyRacesCard({ result, races, onClose }) {
      const { state: stateAbbr, district, formatted } = result;
      const fips = ABBR_TO_FIPS[stateAbbr];
      const stateName = STATES[fips]?.name ?? stateAbbr;
      const data = races[fips];

      // Reuse the full CandidateCard for interactivity (profile links, donate, etc.)

      return (
        <div className="anim-slide-right flex flex-col h-full overflow-hidden">
          <div className="flex items-start justify-between p-4 border-b border-[#2D2A4A] flex-shrink-0">
            <div>
              <h2 className="text-white font-bold text-lg">ğŸ“ Your 2026 Races</h2>
              <p className="text-[#9CA3AF] text-xs mt-0.5">Based on: {formatted || stateAbbr}</p>
            </div>
            <CloseBtn onClick={onClose} />
          </div>

          <div className="flex-1 overflow-y-auto swc-scroll px-4 py-3">
            {data?.senate && (
              <div className="mb-4">
                <div className="text-[#6B7280] text-[11px] uppercase tracking-widest font-semibold mb-1">U.S. Senate â€” {stateName}</div>
                <div className="border-t border-[#2D2A4A] mb-1" />
                {data.senate.candidates.map(c => <CandidateCard key={c.id} c={c} />)}
              </div>
            )}

            {district && data?.house?.[district] ? (
              <div className="mb-4">
                <div className="text-[#6B7280] text-[11px] uppercase tracking-widest font-semibold mb-1">U.S. House â€” {stateAbbr}-{district}</div>
                <div className="border-t border-[#2D2A4A] mb-1" />
                {data.house[district].candidates.map(c => <CandidateCard key={c.id} c={c} />)}
              </div>
            ) : district && !data?.house?.[district] ? (
              <div className="mb-4">
                <div className="text-[#6B7280] text-[11px] uppercase tracking-widest font-semibold mb-1">U.S. House â€” {stateAbbr}-{district}</div>
                <div className="border-t border-[#2D2A4A] mb-1" />
                <p className="text-[#6B7280] text-xs italic py-1">No candidates rated yet for this district. Sign up at Stand With Crypto to stay informed.</p>
              </div>
            ) : !district && data?.house && Object.keys(data.house).length > 0 ? (
              <div className="mb-4">
                <p className="text-[#9CA3AF] text-[11px] italic mb-2">Couldn't pinpoint your exact district â€” showing all House races in {stateName}.</p>
                {Object.entries(data.house).sort((a, b) => Number(a[0]) - Number(b[0])).map(([dist, race]) => (
                  <div key={dist} className="mb-3">
                    <div className="text-[#6B7280] text-[11px] uppercase tracking-widest font-semibold mb-1">U.S. House â€” {stateAbbr}-{dist}</div>
                    <div className="border-t border-[#2D2A4A] mb-1" />
                    {race.candidates.map(c => <CandidateCard key={c.id} c={c} />)}
                  </div>
                ))}
              </div>
            ) : !data?.senate && !data?.house ? (
              <p className="text-[#9CA3AF] text-sm py-4">No rated candidates in your area yet. Sign up to be notified.</p>
            ) : null}

            <p className="text-[#4B5563] text-[11px] mt-2">Your address is used only to identify your district and is never stored.</p>
          </div>

          <div className="p-4 border-t border-[#2D2A4A] flex-shrink-0">
            <CTAButton size="lg" block />
          </div>
        </div>
      );
    }

    /* â”€â”€ Address Search â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function AddressSearch({ onResult }) {
      const [addr, setAddr]         = useState('');
      const [busy, setBusy]         = useState(false);
      const [error, setError]       = useState('');
      const [suggestions, setSugg]  = useState([]);
      const [selIdx, setSelIdx]     = useState(-1);
      const [showDrop, setShowDrop] = useState(false);
      const wrapRef  = useRef(null);

      // Close dropdown on outside click
      useEffect(() => {
        const handler = (e) => { if (wrapRef.current && !wrapRef.current.contains(e.target)) setShowDrop(false); };
        document.addEventListener('mousedown', handler);
        return () => document.removeEventListener('mousedown', handler);
      }, []);

      // Fetch suggestions as user types
      async function handleChange(val) {
        setAddr(val);
        setSelIdx(-1);
        setError('');
        if (val.length < 3) { setSugg([]); setShowDrop(false); return; }
        const results = await nominatimAutocomplete(val);
        setSugg(results);
        setShowDrop(results.length > 0);
      }

      // Keyboard nav in dropdown
      function handleKeyDown(e) {
        if (!showDrop || suggestions.length === 0) return;
        if (e.key === 'ArrowDown') { e.preventDefault(); setSelIdx(i => Math.min(i + 1, suggestions.length - 1)); }
        else if (e.key === 'ArrowUp') { e.preventDefault(); setSelIdx(i => Math.max(i - 1, 0)); }
        else if (e.key === 'Enter' && selIdx >= 0) { e.preventDefault(); pickSuggestion(suggestions[selIdx]); }
        else if (e.key === 'Escape') { setShowDrop(false); }
      }

      function pickSuggestion(s) {
        setAddr(s.full);
        setSugg([]);
        setShowDrop(false);
        doLookup(s.full, s.state);
      }

      async function doLookup(address, knownState) {
        setBusy(true);
        setError('');
        try {
          const result = await censusLookup(address);
          if (result?.state) {
            onResult(result);
          } else if (knownState && ABBR_TO_FIPS[knownState]) {
            onResult({ state: knownState, district: null, formatted: address });
          } else {
            const m = address.toUpperCase().match(/\b([A-Z]{2})\b/g);
            const stateMatch = m && m.find(s => ABBR_TO_FIPS[s]);
            if (stateMatch) {
              onResult({ state: stateMatch, district: null, formatted: address });
            } else {
              setError("Couldn't pinpoint your district â€” try including your full address with zip code.");
            }
          }
        } catch {
          // Census API failed â€” use state from Nominatim or text extraction
          if (knownState && ABBR_TO_FIPS[knownState]) {
            onResult({ state: knownState, district: null, formatted: address });
          } else {
            const m = address.toUpperCase().match(/\b([A-Z]{2})\b/g);
            const stateMatch = m && m.find(s => ABBR_TO_FIPS[s]);
            if (stateMatch) {
              onResult({ state: stateMatch, district: null, formatted: address });
            } else {
              setError("Address lookup failed â€” please try again.");
            }
          }
        } finally {
          setBusy(false);
        }
      }

      function handleSubmit(e) {
        e.preventDefault();
        if (!addr.trim()) return;
        setShowDrop(false);
        doLookup(addr.trim());
      }

      return (
        <form onSubmit={handleSubmit} className="p-4 border-b border-[#2D2A4A] flex-shrink-0">
          <label className="block text-white font-semibold text-sm mb-2">Find your 2026 races</label>
          <div className="flex gap-2 relative" ref={wrapRef}>
            <div className="flex-1 min-w-0 relative">
              <input
                type="text"
                value={addr}
                onChange={e => handleChange(e.target.value)}
                onKeyDown={handleKeyDown}
                onFocus={() => { if (suggestions.length > 0) setShowDrop(true); }}
                placeholder="Start typing your addressâ€¦"
                disabled={busy}
                className="w-full bg-[#0D0D1A] border border-[#2D2A4A] rounded-lg px-3 py-2 text-sm text-white placeholder-[#4B5563] focus:outline-none focus:border-[#F7931A] transition-colors disabled:opacity-50"
                aria-label="Enter your street address"
                autoComplete="off"
                role="combobox"
                aria-expanded={showDrop}
                aria-autocomplete="list"
              />
              {showDrop && suggestions.length > 0 && (
                <div className="ac-dropdown" role="listbox">
                  {suggestions.map((s, i) => (
                    <div
                      key={i}
                      className={`ac-item${i === selIdx ? ' selected' : ''}`}
                      role="option"
                      aria-selected={i === selIdx}
                      onMouseEnter={() => setSelIdx(i)}
                      onClick={() => pickSuggestion(s)}
                    >
                      <div className="ac-main">{s.main}</div>
                      {s.sub && <div className="ac-sub">{s.sub}</div>}
                    </div>
                  ))}
                </div>
              )}
            </div>
            <button type="submit" disabled={busy} className="bg-[#F7931A] hover:bg-[#FFAD4D] disabled:opacity-40 text-white text-sm font-bold px-3 py-2 rounded-lg transition-colors whitespace-nowrap">
              {busy ? <span className="anim-pulse inline-block">â€¦</span> : 'Find My Races'}
            </button>
          </div>
          {error && <p className="text-[#F87171] text-xs mt-2" role="alert">{error}</p>}
          <p className="text-[#4B5563] text-[11px] mt-1.5">Your address is used only to identify your district and is never stored.</p>
        </form>
      );
    }

    /* â”€â”€ Map Legend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function MapLegend() {
      const items = [
        { color: '#F7931A', label: 'Senate Race' },
        { color: '#7B3FE4', label: 'House Races Only' },
      ];
      return (
        <div className="absolute bottom-3 left-3 bg-[#1A1730]/90 backdrop-blur-sm border border-[#2D2A4A] rounded-xl p-3 pointer-events-none" aria-label="Map color legend" role="img">
          <div className="text-[#9CA3AF] text-[10px] uppercase tracking-widest font-semibold mb-2">Legend</div>
          {items.map(({ color, label }) => (
            <div key={label} className="flex items-center gap-2 mb-1 last:mb-0">
              <div className="w-3 h-3 rounded-sm flex-shrink-0" style={{ background: color }} />
              <span className="text-[#D1D5DB] text-xs">{label}</span>
            </div>
          ))}
        </div>
      );
    }

    /* â”€â”€ Hover Tooltip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function HoverTooltip({ fips, races, x, y }) {
      if (!fips) return null;
      const state = STATES[fips];
      if (!state) return null;
      const data = races[fips];
      const senateCount = data?.senate ? 1 : 0;
      const houseCount = data ? Object.keys(data.house).length : 0;

      return (
        <div className="fixed z-50 pointer-events-none bg-[#1A1730] border border-[#2D2A4A] rounded-xl px-3 py-2 shadow-2xl text-sm anim-fade" style={{ left: x + 14, top: y - 8, transform: 'translateY(-100%)' }} role="tooltip">
          <div className="text-white font-semibold">{state.name}</div>
          <div className="text-[#9CA3AF] text-xs mt-0.5">
            {senateCount > 0 && <span>{senateCount} Senate race</span>}
            {senateCount > 0 && houseCount > 0 && <span> Â· </span>}
            {houseCount > 0 && <span>{houseCount} House race{houseCount !== 1 ? 's' : ''}</span>}
            {senateCount === 0 && houseCount === 0 && <span>No rated races</span>}
          </div>
          <div className="text-[#4B5563] text-[11px] mt-1">Click to explore â†’</div>
        </div>
      );
    }

    /* â”€â”€ US Map (D3 geo + React SVG) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function USMap({ colorMap, onStateClick, selectedFips, races }) {
      const [atlas,   setAtlas]   = useState(null);
      const [mapErr,  setMapErr]  = useState(false);
      const [tooltip, setTooltip] = useState({ fips: null, x: 0, y: 0 });

      useEffect(() => {
        d3.json(CONFIG.TOPO_URL).then(setAtlas).catch(() => setMapErr(true));
      }, []);

      const { features, mesh } = useMemo(() => {
        if (!atlas) return { features: [], mesh: null };
        return {
          features: topojson.feature(atlas, atlas.objects.states).features,
          mesh:     topojson.mesh(atlas, atlas.objects.states, (a, b) => a !== b),
        };
      }, [atlas]);

      const pathGen = useMemo(() => {
        const proj = d3.geoAlbersUsa().scale(1300).translate([487, 305]);
        return d3.geoPath().projection(proj);
      }, []);

      if (mapErr) return (
        <div className="flex items-center justify-center w-full h-full text-[#9CA3AF] text-center p-8">
          <div>
            <p className="font-semibold mb-2">Map data temporarily unavailable.</p>
            <CTAButton />
          </div>
        </div>
      );

      if (!atlas) return (
        <div className="flex items-center justify-center w-full h-full">
          <div className="text-[#6B7280] text-sm anim-pulse">Loading mapâ€¦</div>
        </div>
      );

      return (
        <>
          <svg viewBox="0 0 975 610" className="w-full h-auto max-h-full" role="img" aria-label="Interactive US map for 2026 crypto elections">
            {features.map(feat => {
              const fips = String(feat.id).padStart(2, '0');
              const isActive = fips === selectedFips;
              return (
                <path
                  key={fips}
                  d={pathGen(feat)}
                  className="state-path"
                  fill={colorMap[fips] || '#1E1B2E'}
                  stroke={isActive ? '#FFAD4D' : '#0D0D1A'}
                  strokeWidth={isActive ? 2.5 : 0.7}
                  tabIndex={0}
                  role="button"
                  aria-label={`${STATES[fips]?.name ?? fips} â€” click for 2026 race details`}
                  onClick={() => onStateClick(fips)}
                  onKeyDown={e => (e.key === 'Enter' || e.key === ' ') && onStateClick(fips)}
                  onMouseMove={e => setTooltip({ fips, x: e.clientX, y: e.clientY })}
                  onMouseLeave={() => setTooltip({ fips: null, x: 0, y: 0 })}
                />
              );
            })}
            {mesh && <path d={pathGen(mesh)} fill="none" stroke="#0D0D1A" strokeWidth="0.5" pointerEvents="none" />}
          </svg>
          <HoverTooltip {...tooltip} races={races} />
        </>
      );
    }

    /* â”€â”€ Sidebar empty state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function SidebarEmpty({ totalPoliticians, proCount, mixedCount, antiCount }) {
      return (
        <div className="flex flex-col items-center justify-center h-full p-6 text-center gap-4">
          <SWCFullLogo height={36} />
          <div>
            <p className="text-white font-semibold mb-1">Explore the 2026 Races</p>
            <p className="text-[#6B7280] text-sm leading-relaxed">
              Click any state on the map to see which candidates support crypto,
              or enter your address above to find your own races.
            </p>
          </div>
          {totalPoliticians > 0 && (
            <div className="bg-[#2D2A4A]/50 rounded-xl p-4 w-full text-left space-y-2">
              <div className="text-[#9CA3AF] text-xs uppercase tracking-widest font-semibold">National Snapshot</div>
              <div className="text-white text-2xl font-bold">{totalPoliticians} <span className="text-[#6B7280] text-sm font-normal">politicians rated</span></div>
              {[
                { label: 'Pro-Crypto (Aâ€“B)',    count: proCount,   color: '#22C55E', pct: Math.round(proCount / totalPoliticians * 100) },
                { label: 'Neutral (C)',          count: mixedCount, color: '#9CA3AF', pct: Math.round(mixedCount / totalPoliticians * 100) },
                { label: 'Anti-Crypto (F)',      count: antiCount,  color: '#EF4444', pct: Math.round(antiCount / totalPoliticians * 100) },
              ].map(({ label, count, color, pct }) => (
                <div key={label} className="flex items-center gap-2 text-xs">
                  <div className="w-2 h-2 rounded-full flex-shrink-0" style={{ background: color }} />
                  <span className="text-[#D1D5DB] flex-1">{label}</span>
                  <span className="font-semibold tabular-nums" style={{ color }}>{count}</span>
                  <div className="w-16 bg-[#2D2A4A] rounded-full h-1.5">
                    <div className="h-1.5 rounded-full" style={{ background: color, width: `${pct}%` }} />
                  </div>
                </div>
              ))}
            </div>
          )}
          <CTAButton size="md" className="mt-2" />
        </div>
      );
    }

    /* ================================================================
       APP
       ================================================================ */
    function App() {
      const [races,        setRaces]        = useState({});
      const [loading,      setLoading]      = useState(true);
      const [apiError,     setApiError]     = useState(false);
      const [selectedFips, setSelectedFips] = useState(null);
      const [panelMode,    setPanelMode]    = useState(null);   // 'state' | 'races'
      const [myRaces,      setMyRaces]      = useState(null);
      const [mobileOpen,   setMobileOpen]   = useState(false);
      const [rawPeople,    setRawPeople]    = useState([]);

      // Fetch live data from SWC API, fallback to local compact JSON
      useEffect(() => {
        fetch(CONFIG.SWC_API_URL)
          .then(r => { if (!r.ok) throw new Error(); return r.json(); })
          .then(data => {
            const people = data.people || [];
            setRawPeople(people);
            setRaces(buildRaces(people));
            setLoading(false);
          })
          .catch(() => {
            // API failed (CORS, network, etc.) â€” try local fallback
            fetch('swc_embedded_data.json')
              .then(r => r.json())
              .then(compact => {
                const people = decodeCompactData(compact);
                setRawPeople(people);
                setRaces(buildRaces(people));
                setLoading(false);
              })
              .catch(() => { setApiError(true); setLoading(false); });
          });
      }, []);

      // Compute state colour map from live race data
      const colorMap = useMemo(() => {
        const m = {};
        Object.keys(STATES).forEach(fips => { m[fips] = getStateColor(races[fips]); });
        return m;
      }, [races]);

      // Compute national snapshot stats
      const stats = useMemo(() => {
        const relevant = rawPeople.filter(p => {
          const cat = p.primaryRole?.roleCategory;
          return cat === 'SENATE' || cat === 'CONGRESS';
        });
        const scored = relevant.filter(p => (p.manuallyOverriddenStanceScore ?? p.computedStanceScore) != null);
        let pro = 0, mixed = 0, anti = 0;
        scored.forEach(p => {
          const s = p.manuallyOverriddenStanceScore ?? p.computedStanceScore;
          if (s >= 70) pro++;        // A or B grade
          else if (s >= 40) mixed++; // C grade
          else anti++;               // F grade
        });
        return { total: scored.length, pro, mixed, anti };
      }, [rawPeople]);

      function handleStateClick(fips) {
        setSelectedFips(fips);
        setMyRaces(null);
        setPanelMode('state');
        setMobileOpen(true);
      }

      function handleAddressResult(result) {
        const fips = ABBR_TO_FIPS[result.state];
        setMyRaces(result);
        setSelectedFips(fips || null);
        setPanelMode('races');
        setMobileOpen(true);
      }

      function handleClose() {
        setPanelMode(null);
        setSelectedFips(null);
        setMyRaces(null);
        setMobileOpen(false);
      }

      const sidebarContent = () => {
        if (panelMode === 'state' && selectedFips)
          return <StatePanel fips={selectedFips} races={races} onClose={handleClose} />;
        if (panelMode === 'races' && myRaces)
          return <MyRacesCard result={myRaces} races={races} onClose={handleClose} />;
        return <SidebarEmpty totalPoliticians={stats.total} proCount={stats.pro} mixedCount={stats.mixed} antiCount={stats.anti} />;
      };

      if (loading) {
        return (
          <div className="flex flex-col items-center justify-center h-screen bg-[#0D0D1A] gap-4">
            <ShieldIcon size={48} />
            <div className="text-[#6B7280] text-sm anim-pulse">Loading race dataâ€¦</div>
          </div>
        );
      }

      if (apiError) {
        return (
          <div className="flex flex-col items-center justify-center h-screen bg-[#0D0D1A] gap-4 p-8 text-center">
            <ShieldIcon size={48} />
            <p className="text-[#9CA3AF] text-sm">Map data temporarily unavailable.</p>
            <CTAButton />
          </div>
        );
      }

      return (
        <div className="flex flex-col" style={{ height: '100dvh', background: '#0D0D1A', overflow: 'hidden' }}>
          <Header totalPoliticians={stats.total} />

          {/* â”€â”€ Desktop layout (md+) â”€â”€ */}
          <div className="hidden md:flex flex-1 overflow-hidden">
            <aside className="w-[380px] flex-shrink-0 flex flex-col border-r border-[#2D2A4A] bg-[#1A1730] overflow-hidden">
              <AddressSearch onResult={handleAddressResult} />
              <div className="flex-1 overflow-hidden">
                {sidebarContent()}
              </div>
            </aside>

            <main className="flex-1 relative flex items-center justify-center bg-[#0D0D1A] overflow-hidden">
              <div className="w-full h-full flex items-center justify-center p-2 md:p-4">
                <USMap colorMap={colorMap} onStateClick={handleStateClick} selectedFips={selectedFips} races={races} />
              </div>
              <MapLegend />
            </main>
          </div>

          {/* â”€â”€ Mobile layout (< md) â”€â”€ */}
          <div className="flex md:hidden flex-col flex-1 overflow-hidden" style={{ paddingBottom: '64px' }}>
            <div className="relative flex-1 min-h-0 flex items-center justify-center">
              <USMap colorMap={colorMap} onStateClick={handleStateClick} selectedFips={selectedFips} races={races} />
              <MapLegend />
            </div>
            <div className="bg-[#1A1730] border-t border-[#2D2A4A]">
              <AddressSearch onResult={handleAddressResult} />
            </div>
          </div>

          {/* â”€â”€ Mobile bottom sheet â”€â”€ */}
          {mobileOpen && (
            <div className="md:hidden fixed inset-0 z-40 anim-fade" style={{ background: 'rgba(0,0,0,0.65)' }} onClick={handleClose}>
              <div className="anim-slide-up absolute bottom-0 left-0 right-0 bg-[#1A1730] rounded-t-2xl" style={{ maxHeight: '82vh', display: 'flex', flexDirection: 'column' }} onClick={e => e.stopPropagation()}>
                <div className="flex justify-center pt-3 pb-1 flex-shrink-0">
                  <div className="w-10 h-1 bg-[#2D2A4A] rounded-full" />
                </div>
                <div className="flex-1 overflow-hidden">
                  {sidebarContent()}
                </div>
              </div>
            </div>
          )}

          {/* â”€â”€ Mobile fixed CTA â”€â”€ */}
          <div className="md:hidden fixed bottom-0 left-0 right-0 z-30 px-4 py-3 bg-[#0D0D1A] border-t border-[#2D2A4A]">
            <CTAButton size="lg" block />
          </div>
        </div>
      );
    }

    /* â”€â”€ Bootstrap â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
